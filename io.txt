const {
    default: makeWASocket,
    DisconnectReason,
    useMultiFileAuthState
} = require('@adiwajshing/baileys');
const P = require('pino');

async function run() {
    console.log('starting')
    const { state, saveCreds } = await useMultiFileAuthState("baileys_auth_info");
    const sock = await makeWASocket({
        printQRInTerminal: true,
        logger: P({level: 'silent'}),
        auth: state
    });

    sock.ev.on('connection.update', update => {
        const { connection, lastDisconnect} = update;
        if(connection === 'close') {
            if(lastDisconnect.error.hasOwnProperty('output') ? lastDisconnect.error.output.statusCode !== DisconnectReason.loggedOut : true) {
                console.log("Connection error, reconnecting...");
                run();
            } else if(lastDisconnect.error.output.statusCode === DisconnectReason.loggedOut) {
                console.log("Desconnected, reconnecting tryed...");
                run();
            };
        } else if(connection === 'open') {
                console.log("Connected succesfully to WhatsApp.");
        };
    });

    sock.ev.on('creds.update', saveCreds);
    sock.ev.on('messages.upsert', async(m) => {
        await sock.sendMessage(m.messages[0].key.remoteJid, {text: 'hello world'});
    })
}

run();